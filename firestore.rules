rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Allow anyone to create score requests with proper data validation
    match /scoreRequests/{requestId} {
      allow create: if request.resource.data.email is string && 
                       request.resource.data.email.matches('.*@.*\\..*') &&
                       request.resource.data.age is int &&
                       request.resource.data.age >= 1 &&
                       request.resource.data.age <= 150 &&
                       request.resource.data.status == 'pending' &&
                       request.resource.data.createdAt is timestamp &&
                       request.resource.data.emailVerified == false;
      // Allow Cloud Functions to update verification status
      // Note: Cloud Functions using Admin SDK bypass these rules, but this is a fallback
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['emailVerified', 'verifiedAt', 'verificationToken', 'tokenExpiresAt', 'status']) ||
                       // Allow updates from Cloud Functions (they use admin SDK which bypasses rules anyway)
                       request.auth != null;
      // Allow reads for authenticated users (admins via console)
      // Cloud Functions using Admin SDK bypass these rules
      allow read: if request.auth != null;
      allow delete: if false; // Prevent deletion
    }

    // Newsletter subscriptions
    match /newsletterSubscriptions/{subscriptionId} {
      // Allow create with proper validation
      // Note: subscribedAt can be a serverTimestamp() sentinel, so we check it exists
      allow create: if request.resource.data.email is string && 
                       request.resource.data.email.matches('.*@.*\\..*') &&
                       request.resource.data.status == 'active' &&
                       request.resource.data.source is string &&
                       (request.resource.data.subscribedAt is timestamp || 
                        request.resource.data.subscribedAt == request.time);
      // Allow Cloud Functions to update status (e.g., unsubscribe)
      allow update: if request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['status', 'unsubscribedAt']) ||
                       request.auth != null;
      // Allow reads to check for duplicates (needed for frontend duplicate check)
      // This is safe as we're only checking email existence
      allow read: if true;
      allow delete: if false; // Prevent deletion
    }
  }
}

